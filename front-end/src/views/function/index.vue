<template>
  <div>
    <page-header-wrapper>
      <template slot="extra">
        <div class="table-operator">
          <a-button type="primary" icon="plus" @click="showDrawer">Add Function</a-button>
        </div>
      </template>

      <a-card :bordered="false">
        <function-table
          :data="functionList"
          :loadingList="loadingList"
          :onSelFunction="onSelFunction"
          :onShowDetail="onShowDetail"
        />
      </a-card>
    </page-header-wrapper>

    <!-- new funtion -->
    <add-form :visible="visibleDrawer" />
    <!-- trigger -->
    <trigger :visible="visibleTrigger" :data="functionList" :currentFunction="currentFunction" />
    <!-- detail -->
    <function-detail-vue :visible="visibleDetail" :currentFuncionInfo="currentFuncionInfo" />
  </div>
</template>
<script>
import AddForm from './components/AddForm.vue'
import FunctionDetailVue from './components/FunctionDetail.vue'
import FunctionTable from './components/FunctionTable'
import Trigger from './components/Trigger.vue'
import { getList, getStatus, getInfo, getStats } from '@/api/func'

export default {
  data() {
    return {
      functionList: [],
      visibleDrawer: false,
      visibleTrigger: false,
      visibleDetail: false,
      currentFunction: {},
      currentFuncionInfo: {},
      loadingList: false,
    }
  },
  components: {
    FunctionTable,
    AddForm,
    Trigger,
    FunctionDetailVue,
  },
  async mounted() {
    this.loadingList = true
    try {
      const res = await getList()
      if (Array.isArray(res)) {
        this.functionList = res?.map((name) => ({ key: name, name }))

        // get status
        res?.map(async (name, i) => {
          const res = await getStatus(name)
          this.$set(this.functionList[i], 'status', !!res?.instances?.[0]?.status?.running)
        })
      }
    } catch (e) {}
    this.loadingList = false
  },
  methods: {
    formatDate(date) {
      return moment(date).format('YYYY/MM/DD')
    },
    showDrawer() {
      this.visibleDrawer = true
    },
    closeDrawer() {
      this.visibleDrawer = false
    },
    showTrigger() {
      this.visibleTrigger = true
    },
    closeTrigger() {
      this.visibleTrigger = false
    },
    showDetail() {
      this.visibleDetail = true
    },
    closeDetail() {
      this.visibleDetail = false
    },
    onSelFunction(value) {
      this.currentFunction = value
      this.showTrigger()
    },
    onShowDetail(value) {
      this.currentFuncionInfo = { ...this.currentFuncionInfo, ...value }
      this.showDetail()
      const { name } = value
      getInfo(name).then((res) => {
        if (!res) return
        const { inputSpecs = {} } = res
        const input = Object.keys(inputSpecs)?.[0]
        this.currentFuncionInfo = { ...this.currentFuncionInfo, ...res, input }
      })
      getStats(name).then((res) => {
        if (!res) return
        this.currentFuncionInfo = { ...this.currentFuncionInfo, ...res }
      })
    },
  },
}
</script>